name: Manage Ingress Controller instances

on:
  workflow_dispatch:
jobs:
  deploy-ingress-with-custom-http-snippet-config-map:
    runs-on: ubuntu-latest
    environment: ingress-nginx
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: ci-cluster

      - name: Verify cluster
        run: kubectl get nodes

      - name: Create temporary values file with http-snippet
        env:
          HTTP_SNIPPET: ${{ secrets.HTTP_SNIPPET }}
        run: |
          echo "Creating temporary secret values file..."
          cat > /tmp/secret-values.yaml <<EOF
          controller:
            config:
              http-snippet: |
          $(echo "$HTTP_SNIPPET" | sed 's/^/      /')
          EOF

          echo "Secret values file created:"
          cat /tmp/secret-values.yaml | sed 's/./*/g' # hide secret content in logs

      - name: Helm install
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --version 4.13.2 \
            --values ingress/values.yaml \
            --values /tmp/secret-values.yaml

      - name: Verify install with config map from environment secret
        run: |
          kubectl get cm ingress-nginx-controller -o yaml -n ingress-nginx